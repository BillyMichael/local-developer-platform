apiVersion: v1
kind: ServiceAccount
metadata:
  name: gitea-token-generator
  namespace: vcs
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: gitea-token-generator-role
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "get", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gitea-token-generator-binding
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
subjects:
  - kind: ServiceAccount
    name: gitea-token-generator
    namespace: vcs
roleRef:
  kind: ClusterRole
  name: gitea-token-generator-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-generate-token
  namespace: vcs
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    spec:
      serviceAccountName: gitea-token-generator
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              echo "Waiting for Gitea pod to be ready..."
              kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=gitea -n vcs --timeout=300s
              
              POD_NAME=$(kubectl get pod -l app.kubernetes.io/name=gitea -n vcs -o jsonpath="{.items[0].metadata.name}")
              echo "Found Gitea pod: $POD_NAME"

              # Delete existing token if it exists (ignore error)
              echo "Cleaning up old token..."
              kubectl exec -n vcs $POD_NAME -- su git -c "/usr/local/bin/gitea admin user delete-access-token --username gitea_admin --token-name backstage-token" || true

              # Generate new token
              echo "Generating new token..."
              TOKEN=$(kubectl exec -n vcs $POD_NAME -- su git -c "/usr/local/bin/gitea admin user generate-access-token --username gitea_admin --token-name backstage-token --scopes write:repository,read:user,write:admin,write:user --raw")
              
              if [ -z "$TOKEN" ]; then
                echo "Failed to generate token"
                exit 1
              fi

              echo "Token generated successfully."

              # Create/Update Secret in Portal namespace
              echo "Creating secret in portal namespace..."
              kubectl create secret generic backstage-gitea-token --from-literal=token=$TOKEN -n portal --dry-run=client -o yaml | kubectl apply -f -
              
              echo "Done!"
      restartPolicy: OnFailure
