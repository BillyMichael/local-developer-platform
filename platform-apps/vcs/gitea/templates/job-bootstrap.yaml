apiVersion: v1
kind: ServiceAccount
metadata:
  name: gitea-bootstrap
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
---
# Namespace-scoped Role - only has permissions within vcs namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gitea-bootstrap-role
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "get", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gitea-bootstrap-binding
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
subjects:
  - kind: ServiceAccount
    name: gitea-bootstrap
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: gitea-bootstrap-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-bootstrap
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    spec:
      serviceAccountName: gitea-bootstrap
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              NAMESPACE="{{ .Release.Namespace }}"

              echo "Waiting for Gitea pod to be ready..."
              kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=gitea -n $NAMESPACE --timeout=300s

              POD_NAME=$(kubectl get pod -l app.kubernetes.io/name=gitea -n $NAMESPACE -o jsonpath="{.items[0].metadata.name}")
              echo "Found Gitea pod: $POD_NAME"

              # Check if secret already exists - skip token generation if so
              if kubectl get secret gitea-admin-token -n $NAMESPACE >/dev/null 2>&1; then
                echo "Token secret already exists, skipping token generation"
                TOKEN=$(kubectl get secret gitea-admin-token -n $NAMESPACE -o jsonpath='{.data.token}' | base64 -d)
              else
                echo "Generating new token..."
                TOKEN=$(kubectl exec -n $NAMESPACE $POD_NAME -- /usr/local/bin/gitea admin user generate-access-token --username gitea_admin --token-name backstage-token --scopes write:repository,read:organization,write:organization,read:user,write:admin,write:user --raw)
              fi

              if [ -z "$TOKEN" ]; then
                echo "Failed to get or generate token"
                exit 1
              fi

              # Only create secret if it doesn't exist yet
              if ! kubectl get secret gitea-admin-token -n $NAMESPACE >/dev/null 2>&1; then
                echo "Creating secret in $NAMESPACE namespace with Replicator annotation..."
                cat <<EOF | kubectl apply -f -
              apiVersion: v1
              kind: Secret
              metadata:
                name: gitea-admin-token
                namespace: $NAMESPACE
                annotations:
                  replicator.v1.mittwald.de/replicate-to: "portal"
              type: Opaque
              stringData:
                token: "$TOKEN"
              EOF
                echo "Secret created and will be replicated to portal."
              fi

              # Create default organization if it doesn't exist
              echo "Creating default organization..."
              kubectl exec -n $NAMESPACE $POD_NAME -- wget -q -O- \
                --header="Authorization: token $TOKEN" \
                --header="Content-Type: application/json" \
                --post-data='{"username":"local-developer-platform","full_name":"Local Developer Platform","description":"Platform infrastructure and services","visibility":"public"}' \
                http://localhost:3000/api/v1/orgs 2>/dev/null || echo "Organization may already exist"

              echo "Setup complete!"
      restartPolicy: OnFailure
