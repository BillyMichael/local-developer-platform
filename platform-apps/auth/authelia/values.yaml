authelia:
  ingress:
    enabled: true
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      cert-manager.io/cluster-issuer: ca-issuer
    tls:
      enabled: true
      secret: authelia-tls

  configMap:
    theme: dark
    log:
      level: trace

    ntp:
      disable_startup_check: true
      disable_failure: true

    authentication_backend:
      refresh_interval: 1h
      ldap:
        enabled: true
        implementation: lldap
        address: ldap://lldap-chart-service:3890
        base_dn: DC=ldp,DC=com
        additional_users_dn: OU=people
        additional_groups_dn: OU=groups
        groups_filter: (member={dn})
        user: UID=svc_authelia,OU=people,DC=ldp,DC=com
        password:
          secret_name: lldap-authelia-credentials
          path: password

    access_control:
      default_policy: deny
      rules:
        - domain: "*"
          policy: one_factor

    storage:
      local:
        enabled: true
        path: /config/db.sqlite3

    notifier:
      filesystem:
        enabled: true

    session:
      cookies:
        - name: authelia_session
          domain: auth-127-0-0-1.nip.io
          authelia_url: https://auth-127-0-0-1.nip.io
          same_site: lax
          secure: true
          expiration: 1h
          inactivity: 5m
          remember_me: 1M

    identity_providers:
      oidc:
        enabled: true

        jwks:
          - key_id: default
            algorithm: RS256
            use: sig
            key:
              path: /secrets/jwk-rsa/tls.key
            certificate_chain:
              path: /secrets/jwk-rsa/tls.crt

        lifespans:
          access_token: 1h
          authorize_code: 1m
          id_token: 1h
          refresh_token: 90m

        cors:
          endpoints: [authorization, token, revocation, introspection]
          allowed_origins: ["*"]

        claims_policies:
          default:
            id_token: [groups, email, preferred_username, name]

        enable_client_debug_messages: true

        clients:
          - client_id: argocd
            client_name: Argo CD
            public: false
            authorization_policy: one_factor
            consent: implicit
            redirect_uris:
              - https://cd-127-0-0-1.nip.io/auth/callback
            scopes: [openid, groups, email]
            grant_types: [authorization_code]
            response_types: [code]
            token_endpoint_auth_method: client_secret_basic
            access_token_signed_response_alg: none
            userinfo_signed_response_alg: none
            client_secret:
              path: /hashed-secrets/argocd-password

          - client_id: argocd-cli
            client_name: Argo CD (CLI)
            public: true
            authorization_policy: one_factor
            require_pkce: true
            pkce_challenge_method: S256
            consent: implicit
            redirect_uris:
              - https://cd-127-0-0-1.nip.io/auth/callback
            scopes: [openid, offline_access, groups, email]
            grant_types: [authorization_code, refresh_token]
            response_types: [code]
            token_endpoint_auth_method: none
            access_token_signed_response_alg: none
            userinfo_signed_response_alg: none

          - client_id: backstage-client
            client_name: Backstage Portal
            public: false
            authorization_policy: one_factor
            require_pkce: true
            pkce_challenge_method: S256
            consent: implicit
            redirect_uris:
              - https://portal-127-0-0-1.nip.io/api/auth/oidc/handler/frame
              - https://portal-127-0-0-1.nip.io/api/auth/oidc/handler
            scopes: [openid, profile, email, offline_access]
            grant_types: [authorization_code, refresh_token]
            response_types: [code]
            client_secret:
              path: /hashed-secrets/backstage-password

          - client_id: kargo
            client_name: Kargo
            public: true
            authorization_policy: one_factor
            consent: implicit
            redirect_uris:
              - https://kargo-127-0-0-1.nip.io/login
            scopes: [openid, profile, offline_access, groups, email]
            grant_types: [authorization_code]
            response_types: [code]
            token_endpoint_auth_method: none
            access_token_signed_response_alg: none
            userinfo_signed_response_alg: none

          - client_id: gitea
            client_name: Gitea
            public: false
            authorization_policy: one_factor
            consent: implicit
            redirect_uris:
              - https://vcs-127-0-0-1.nip.io/user/oauth2/Authelia/callback
            scopes: [openid, profile, email, groups]
            grant_types: [authorization_code]
            response_types: [code]
            token_endpoint_auth_method: client_secret_basic
            access_token_signed_response_alg: none
            userinfo_signed_response_alg: none
            client_secret:
              path: /hashed-secrets/gitea-password

  pod:
    kind: Deployment

    extraVolumes:
      - name: hashed-secrets
        emptyDir: {}

    extraVolumeMounts:
      - name: hashed-secrets
        mountPath: /hashed-secrets

    initContainers:
      - name: hash-oidc-secrets
        image: authelia/authelia:latest
        command:
          - sh
          - -c
          - |
            echo "Hashing OIDC client secrets..."

            # Hash ArgoCD client secret
            ls /secrets/
            cat /secrets/argocd-oidc-client-secret/
            ARGOCD_PLAIN=$(cat /secrets/argocd-oidc-client-secret/password)
            echo "$ARGOCD_PLAIN" | authelia crypto hash generate pbkdf2 --variant sha512 > /hashed-secrets/argocd-password

            # Hash Backstage client secret
            BACKSTAGE_PLAIN=$(cat /secrets/backstage-oidc-client-secret/password)
            echo "$BACKSTAGE_PLAIN" | authelia crypto hash generate pbkdf2 --variant sha512 > /hashed-secrets/backstage-password

            # Hash Gitea client secret
            GITEA_PLAIN=$(cat /secrets/gitea-oidc-client-secret/password)
            echo "$GITEA_PLAIN" | authelia crypto hash generate pbkdf2 --variant sha512 > /hashed-secrets/gitea-password

            echo "All secrets hashed successfully"
        volumeMounts:
          - name: secret-argocd-oidc-client-secret
            mountPath: /secrets/argocd-oidc-client-secret
            readOnly: true
          - name: secret-backstage-oidc-client-secret
            mountPath: /secrets/backstage-oidc-client-secret
            readOnly: true
          - name: secret-gitea-oidc-client-secret
            mountPath: /secrets/gitea-oidc-client-secret
            readOnly: true
          - name: hashed-secrets
            mountPath: /hashed-secrets

  secret:
    additionalSecrets:
      lldap-authelia-credentials: {}
      jwk-rsa:
        items:
          - key: tls.key
            path: tls.key
          - key: tls.crt
            path: tls.crt
      argocd-oidc-client-secret:
        items:
          - key: password
            path: password
      backstage-oidc-client-secret:
        items:
          - key: password
            path: password
      gitea-oidc-client-secret:
        items:
          - key: password
            path: password